<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Correlação BTC/ETH</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group label {
            font-weight: 600;
            color: #495057;
        }
        
        .control-group select, .control-group input {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: scale(1.05);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .content {
            padding: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #6c757d;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: grid;
            gap: 20px;
        }
        
        .card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #6c757d;
            font-weight: 500;
        }
        
        .metric-value {
            color: #212529;
            font-weight: 700;
            font-size: 1.1em;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .price-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .price-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .price-card h4 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .price-card .price {
            font-size: 2em;
            font-weight: 700;
        }
        
        .tip {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Analisador de Correlação Crypto</h1>
            <p>Análise em Tempo Real de BTC/ETH</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>Intervalo:</label>
                <select id="interval">
                    <option value="1m">1 minuto</option>
                    <option value="5m">5 minutos</option>
                    <option value="15m">15 minutos</option>
                    <option value="1h">1 hora</option>
                </select>
                
                <label>Períodos:</label>
                <input type="number" id="limit" value="100" min="50" max="500">
                
                <button onclick="executarAnalise()" id="btnAnalise">
                    🚀 Analisar Agora
                </button>
            </div>
            
            <div class="tip" style="margin-top: 15px;">
                💡 <strong>Dica:</strong> Se der erro de conexão, experimente usar este arquivo em um servidor local ou hospedado online (como GitHub Pages, Netlify, etc)
            </div>
        </div>
        
        <div class="content" id="content">
            <div class="alert alert-info">
                👆 Configure os parâmetros acima e clique em "Analisar Agora" para obter dados reais da Binance
            </div>
        </div>
    </div>

    <script>
        async function obterDados(symbol, interval, limit) {
            // Usando proxy CORS gratuito para contornar o bloqueio
            const corsProxy = 'https://api.allorigins.win/raw?url=';
            const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`;
            
            try {
                const response = await fetch(corsProxy + encodeURIComponent(url));
                if (!response.ok) throw new Error('Erro na requisição');
                
                const data = await response.json();
                return data.map(candle => parseFloat(candle[4])); // Preço de fechamento
            } catch (error) {
                // Tentar sem proxy como fallback
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    return data.map(candle => parseFloat(candle[4]));
                } catch (e) {
                    throw new Error('Não foi possível conectar à API. Tente: 1) Usar HTTPS em vez de arquivo local, 2) Desabilitar extensões de bloqueio, 3) Usar o código Python no Colab');
                }
            }
        }

        function calcularDirecao(closes) {
            const dirs = [];
            for (let i = 1; i < closes.length; i++) {
                const diff = closes[i] - closes[i-1];
                if (diff > 0) dirs.push(1);
                else if (diff < 0) dirs.push(-1);
                else dirs.push(0);
            }
            return dirs;
        }

        function calcularCorrelacao(arr1, arr2) {
            const n = arr1.length;
            const mean1 = arr1.reduce((a, b) => a + b) / n;
            const mean2 = arr2.reduce((a, b) => a + b) / n;
            
            let num = 0, den1 = 0, den2 = 0;
            for (let i = 0; i < n; i++) {
                const diff1 = arr1[i] - mean1;
                const diff2 = arr2[i] - mean2;
                num += diff1 * diff2;
                den1 += diff1 * diff1;
                den2 += diff2 * diff2;
            }
            
            return num / Math.sqrt(den1 * den2);
        }

        function analisarDivergencias(btcDir, ethDir) {
            const divergencias = [];
            for (let i = 0; i < btcDir.length; i++) {
                const isDivergent = (btcDir[i] !== ethDir[i]) && 
                                   (btcDir[i] !== 0) && 
                                   (ethDir[i] !== 0);
                divergencias.push(isDivergent);
            }
            
            // Contar sequências
            const sequences = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
            let maxStreak = 0;
            let currentStreak = 0;
            
            for (let i = 0; i < divergencias.length; i++) {
                if (divergencias[i]) {
                    currentStreak++;
                } else {
                    if (currentStreak > 0) {
                        const key = Math.min(currentStreak, 5);
                        sequences[key]++;
                        maxStreak = Math.max(maxStreak, currentStreak);
                    }
                    currentStreak = 0;
                }
            }
            
            if (currentStreak > 0) {
                const key = Math.min(currentStreak, 5);
                sequences[key]++;
                maxStreak = Math.max(maxStreak, currentStreak);
            }
            
            // Análise de reversões
            const reversoes = {1: {btc: 0, eth: 0, both: 0, none: 0},
                              2: {btc: 0, eth: 0, both: 0, none: 0},
                              3: {btc: 0, eth: 0, both: 0, none: 0},
                              4: {btc: 0, eth: 0, both: 0, none: 0},
                              5: {btc: 0, eth: 0, both: 0, none: 0}};
            
            let i = 0;
            while (i < divergencias.length) {
                if (divergencias[i]) {
                    const seqStart = i;
                    let seqLen = 0;
                    while (i < divergencias.length && divergencias[i]) {
                        seqLen++;
                        i++;
                    }
                    
                    if (i < btcDir.length && seqStart > 0) {
                        const btcBefore = btcDir[seqStart - 1];
                        const ethBefore = ethDir[seqStart - 1];
                        const btcAfter = btcDir[i];
                        const ethAfter = ethDir[i];
                        
                        const btcRev = (btcAfter !== 0) && (btcBefore !== 0) && (btcAfter !== btcBefore);
                        const ethRev = (ethAfter !== 0) && (ethBefore !== 0) && (ethAfter !== ethBefore);
                        
                        const key = Math.min(seqLen, 5);
                        
                        if (btcRev && !ethRev) reversoes[key].btc++;
                        else if (!btcRev && ethRev) reversoes[key].eth++;
                        else if (btcRev && ethRev) reversoes[key].both++;
                        else reversoes[key].none++;
                    }
                } else {
                    i++;
                }
            }
            
            return {
                divergencias,
                sequences,
                maxStreak,
                reversoes,
                totalDivergencias: divergencias.filter(d => d).length
            };
        }

        async function executarAnalise() {
            const btn = document.getElementById('btnAnalise');
            const content = document.getElementById('content');
            const interval = document.getElementById('interval').value;
            const limit = parseInt(document.getElementById('limit').value);
            
            btn.disabled = true;
            btn.textContent = '⏳ Analisando...';
            
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Obtendo dados da Binance via proxy...</p>
                    <p style="font-size: 0.9em; color: #999; margin-top: 10px;">Isso pode levar alguns segundos...</p>
                </div>
            `;
            
            try {
                const btcCloses = await obterDados('BTCUSDT', interval, limit);
                const ethCloses = await obterDados('ETHUSDT', interval, limit);
                
                const btcDir = calcularDirecao(btcCloses);
                const ethDir = calcularDirecao(ethCloses);
                
                const correlacao = calcularCorrelacao(btcCloses, ethCloses);
                const analise = analisarDivergencias(btcDir, ethDir);
                
                // Exibir resultados
                const taxaDivergencia = (analise.totalDivergencias / btcDir.length * 100).toFixed(1);
                
                let html = `
                    <div class="alert alert-success">
                        ✅ Análise concluída com sucesso! Dados obtidos em ${new Date().toLocaleString('pt-BR')}
                    </div>
                    
                    <div class="price-info">
                        <div class="price-card">
                            <h4>Bitcoin (BTC)</h4>
                            <div class="price">$${btcCloses[btcCloses.length-1].toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        </div>
                        <div class="price-card">
                            <h4>Ethereum (ETH)</h4>
                            <div class="price">$${ethCloses[ethCloses.length-1].toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        </div>
                    </div>
                    
                    <div class="results">
                        <div class="card">
                            <h3>📊 Correlação e Estatísticas</h3>
                            <div class="metric">
                                <span class="metric-label">Correlação BTC/ETH:</span>
                                <span class="metric-value">${correlacao.toFixed(4)}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Total de candles:</span>
                                <span class="metric-value">${limit}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Total de divergências:</span>
                                <span class="metric-value">${analise.totalDivergencias}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Taxa de divergência:</span>
                                <span class="metric-value">${taxaDivergencia}%</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Máximo consecutivo:</span>
                                <span class="metric-value">${analise.maxStreak} candles</span>
                            </div>
                        </div>
                        
                        <div class="card">
                            <h3>🔄 Sequências de Divergências</h3>
                `;
                
                for (let n = 1; n <= 5; n++) {
                    html += `
                        <div class="metric">
                            <span class="metric-label">${n} candle(s) consecutivo(s):</span>
                            <span class="metric-value">${analise.sequences[n]} ocorrências</span>
                        </div>
                    `;
                }
                
                html += `</div><div class="card"><h3>📈 Análise de Reversões</h3>`;
                
                for (let n = 1; n <= 5; n++) {
                    const total = analise.reversoes[n].btc + analise.reversoes[n].eth + 
                                 analise.reversoes[n].both + analise.reversoes[n].none;
                    if (total > 0) {
                        html += `
                            <h4 style="margin-top: 15px; color: #667eea;">Após ${n} candle(s) divergente(s):</h4>
                            <div class="metric">
                                <span class="metric-label">↗️ Reversão apenas BTC:</span>
                                <span class="metric-value">${analise.reversoes[n].btc} (${(analise.reversoes[n].btc/total*100).toFixed(1)}%)</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">↘️ Reversão apenas ETH:</span>
                                <span class="metric-value">${analise.reversoes[n].eth} (${(analise.reversoes[n].eth/total*100).toFixed(1)}%)</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">🔄 Reversão de AMBOS:</span>
                                <span class="metric-value">${analise.reversoes[n].both} (${(analise.reversoes[n].both/total*100).toFixed(1)}%)</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">➡️ Sem reversão:</span>
                                <span class="metric-value">${analise.reversoes[n].none} (${(analise.reversoes[n].none/total*100).toFixed(1)}%)</span>
                            </div>
                        `;
                    }
                }
                
                html += `</div><div class="card"><h3>💡 Insights para Trading</h3>`;
                
                if (correlacao > 0.8) {
                    html += '<div class="alert alert-success">✓ Alta correlação positiva - BTC e ETH movem-se juntos</div>';
                } else if (correlacao > 0.5) {
                    html += '<div class="alert alert-info">✓ Correlação positiva moderada</div>';
                } else if (correlacao < -0.5) {
                    html += '<div class="alert alert-warning">⚠ Correlação negativa - movimentos opostos</div>';
                } else {
                    html += '<div class="alert alert-info">• Correlação fraca - movimentos independentes</div>';
                }
                
                if (analise.maxStreak >= 5) {
                    html += `<div class="alert alert-warning">⚠️ ALERTA: Houve sequência de ${analise.maxStreak} candles divergentes! Isso pode indicar oportunidade de reversão ou arbitragem.</div>`;
                }
                
                html += `<div class="alert alert-info">📉 Taxa de divergência: ${taxaDivergencia}% dos candles analisados</div>`;
                
                html += `</div></div>`;
                
                content.innerHTML = html;
                
            } catch (error) {
                content.innerHTML = `
                    <div class="alert alert-warning">
                        ❌ <strong>Erro ao obter dados:</strong> ${error.message}
                    </div>
                    <div class="alert alert-info">
                        <strong>💡 Soluções alternativas:</strong><br><br>
                        <strong>Opção 1 - Use o Google Colab (RECOMENDADO):</strong><br>
                        1. Acesse: <a href="https://colab.research.google.com" target="_blank">colab.research.google.com</a><br>
                        2. Crie um novo notebook<br>
                        3. Cole o código Python (primeiro artifact) e execute<br><br>
                        
                        <strong>Opção 2 - Hospede este arquivo:</strong><br>
                        1. Crie conta gratuita em <a href="https://pages.github.com/" target="_blank">GitHub Pages</a> ou <a href="https://www.netlify.com/" target="_blank">Netlify</a><br>
                        2. Faça upload deste arquivo HTML<br>
                        3. Acesse via URL do serviço<br><br>
                        
                        <strong>Opção 3 - Desabilite bloqueios:</strong><br>
                        • Desative temporariamente extensões de bloqueio (AdBlock, Privacy Badger, etc)<br>
                        • Tente em modo anônimo do navegador
                    </div>
                `;
            }
            
            btn.disabled = false;
            btn.textContent = '🚀 Analisar Agora';
        }
        
        // Tentar análise automática ao carregar (opcional)
        // window.onload = () => setTimeout(executarAnalise, 1000);
    </script>
</body>
</html>